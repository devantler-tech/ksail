name: KSail System Test
description: |
  Runs a full end-to-end system test of KSail, testing cluster lifecycle
  and workload management capabilities.

inputs:
  distribution:
    description: Kubernetes distribution (Vanilla, K3s, Talos)
    required: true
  provider:
    description: Infrastructure provider (Docker, Hetzner)
    required: false
    default: "Docker"
  args:
    description: Additional arguments for cluster init/create
    required: false
    default: ""
  init:
    description: Whether to run ksail cluster init before create
    required: false
    default: "false"
  test-workload-image:
    description: Image to use for workload create test
    required: false
    default: "traefik/whoami:latest"
  test-workload-name:
    description: Name for the test workload deployment
    required: false
    default: "whoami"
  apply-overlay-path:
    description: Path to kustomize overlay for workload apply test
    required: false
    default: ""
  gitops-path:
    description: Path for GitOps push (only if --gitops-engine in args)
    required: false
    default: "k8s"
  workload-timeout:
    description: Timeout for workload wait operations
    required: false
    default: "300s"
  hcloud-token:
    description: Hetzner Cloud API token (required when provider is Hetzner)
    required: false
    default: ""
  ghcr-user:
    description: GitHub Container Registry username (for external registry auth)
    required: false
    default: ""
  ghcr-token:
    description: GitHub Container Registry token (for external registry auth)
    required: false
    default: ""
  enable-image-cache:
    description: |
      Enable container image caching using ksail workload export/import.
      This can speed up cluster startup by pre-loading cached images.
      Note: Only works for Vanilla (Kind) and K3s (K3d) distributions.
    required: false
    default: "true"
  image-cache-version:
    description: |
      Version salt for image cache key. Bump this to invalidate all image caches.
    required: false
    default: "v1"

runs:
  using: composite
  steps:
    - name: ğŸ”§ Generate unique artifact tag
      id: generate-tag
      shell: bash
      env:
        DISTRIBUTION: ${{ inputs.distribution }}
        PROVIDER: ${{ inputs.provider }}
        INIT: ${{ inputs.init }}
        ARGS: ${{ inputs.args }}
      run: |
        # Generate unique tag: distribution-provider-init-sanitized_args-shortsha
        DIST_LOWER=$(echo "$DISTRIBUTION" | tr '[:upper:]' '[:lower:]')
        PROVIDER_LOWER=$(echo "$PROVIDER" | tr '[:upper:]' '[:lower:]')
        INIT_SUFFIX=$([ "$INIT" = "true" ] && echo "init" || echo "no-init")
        # Sanitize args: extract key values, remove special chars, lowercase
        ARGS_SANITIZED=$(echo "$ARGS" | sed 's/--[a-z-]*=\?//g' | tr '[:upper:]' '[:lower:]' | tr -cs 'a-z0-9' '-' | sed 's/^-//;s/-$//' | cut -c1-30)
        SHORT_SHA="${GITHUB_SHA:0:7}"
        if [[ -n "$ARGS_SANITIZED" ]]; then
          TAG="${DIST_LOWER}-${PROVIDER_LOWER}-${INIT_SUFFIX}-${ARGS_SANITIZED}-${SHORT_SHA}"
        else
          TAG="${DIST_LOWER}-${PROVIDER_LOWER}-${INIT_SUFFIX}-${SHORT_SHA}"
        fi
        echo "tag=$TAG" >> "$GITHUB_OUTPUT"
        echo "Generated unique artifact tag: $TAG"

    - name: ğŸ”§ Resolve GHCR credentials in args
      id: resolve-args
      shell: bash
      env:
        ARGS: ${{ inputs.args }}
        GHCR_USER: ${{ inputs.ghcr-user }}
        GHCR_TOKEN: ${{ inputs.ghcr-token }}
        ARTIFACT_TAG: ${{ steps.generate-tag.outputs.tag }}
      run: |
        # Inject GHCR credentials into --local-registry if it contains ghcr.io
        RESOLVED_ARGS="$ARGS"
        if [[ "$ARGS" == *"--local-registry"* ]] && [[ "$ARGS" == *"ghcr.io"* ]] && [[ -n "$GHCR_USER" ]] && [[ -n "$GHCR_TOKEN" ]]; then
          # Replace 'ghcr.io/' with 'user:token@ghcr.io/'
          RESOLVED_ARGS="${ARGS//ghcr.io\//${GHCR_USER}:${GHCR_TOKEN}@ghcr.io/}"
          # Append unique tag to avoid collisions between parallel CI runs
          # Format: user:token@ghcr.io/org/repo/path -> user:token@ghcr.io/org/repo/path:tag
          RESOLVED_ARGS="${RESOLVED_ARGS}:${ARTIFACT_TAG}"
        fi
        echo "args=$RESOLVED_ARGS" >> "$GITHUB_OUTPUT"

    - name: ğŸ§ª ksail cluster init
      if: inputs.init == 'true'
      shell: bash
      env:
        DISTRIBUTION: ${{ inputs.distribution }}
        PROVIDER: ${{ inputs.provider }}
        ARGS: ${{ steps.resolve-args.outputs.args }}
        HCLOUD_TOKEN: ${{ inputs.hcloud-token }}
      run: |
        ksail cluster init --distribution "$DISTRIBUTION" --provider "$PROVIDER" $ARGS --force

    - name: ğŸ§ª ksail cluster create
      id: cluster-create
      shell: bash
      env:
        INIT: ${{ inputs.init }}
        DISTRIBUTION: ${{ inputs.distribution }}
        PROVIDER: ${{ inputs.provider }}
        ARGS: ${{ steps.resolve-args.outputs.args }}
        HCLOUD_TOKEN: ${{ inputs.hcloud-token }}
      run: |
        if [ "$INIT" = "true" ]; then
          ksail cluster create
        else
          ksail cluster create --distribution "$DISTRIBUTION" --provider "$PROVIDER" $ARGS
        fi

    - name: ğŸ“¥ Restore cached cluster images
      id: restore-image-cache
      if: inputs.enable-image-cache == 'true'
      uses: ./.github/actions/cache-cluster-images
      with:
        distribution: ${{ inputs.distribution }}
        operation: restore
        cache-version: ${{ inputs.image-cache-version }}

    - name: ğŸ§ª ksail cluster list
      shell: bash
      env:
        HCLOUD_TOKEN: ${{ inputs.hcloud-token }}
      run: |
        ksail cluster list

    - name: ğŸ§ª ksail workload create
      id: workload-create
      shell: bash
      env:
        WORKLOAD_NAME: ${{ inputs.test-workload-name }}
        WORKLOAD_IMAGE: ${{ inputs.test-workload-image }}
        TIMEOUT: ${{ inputs.workload-timeout }}
        HCLOUD_TOKEN: ${{ inputs.hcloud-token }}
      run: |
        ksail workload create deployment "$WORKLOAD_NAME" --image="$WORKLOAD_IMAGE"
        ksail workload wait --for=condition=Available deployment/"$WORKLOAD_NAME" --timeout="$TIMEOUT"

    - name: ğŸ§ª ksail workload apply
      id: workload-apply
      if: inputs.apply-overlay-path != ''
      shell: bash
      env:
        OVERLAY_PATH: ${{ inputs.apply-overlay-path }}
        TIMEOUT: ${{ inputs.workload-timeout }}
        HCLOUD_TOKEN: ${{ inputs.hcloud-token }}
      run: ksail workload apply -k "$OVERLAY_PATH" --wait --timeout="$TIMEOUT"

    - name: ğŸ§ª ksail workload push and reconcile
      id: workload-push-reconcile
      if: contains(inputs.args, '--gitops-engine')
      shell: bash
      env:
        GITOPS_PATH: ${{ inputs.gitops-path }}
        HCLOUD_TOKEN: ${{ inputs.hcloud-token }}
        GHCR_USER: ${{ inputs.ghcr-user }}
        GHCR_TOKEN: ${{ inputs.ghcr-token }}
      run: |
        mkdir -p "$GITOPS_PATH"
        if [ ! -f "$GITOPS_PATH/kustomization.yaml" ]; then
          echo "apiVersion: kustomize.config.k8s.io/v1beta1" > "$GITOPS_PATH/kustomization.yaml"
          echo "kind: Kustomization" >> "$GITOPS_PATH/kustomization.yaml"
          echo "resources: []" >> "$GITOPS_PATH/kustomization.yaml"
        fi
        ksail workload push --path "$GITOPS_PATH/"
        ksail workload reconcile

    - name: ğŸ’¾ Save cluster images to cache
      if: inputs.enable-image-cache == 'true' && steps.restore-image-cache.outputs.cache-hit != 'true' && steps.restore-image-cache.outputs.skipped != 'true'
      uses: ./.github/actions/cache-cluster-images
      with:
        distribution: ${{ inputs.distribution }}
        operation: save
        cache-version: ${{ inputs.image-cache-version }}

    - name: ğŸ Debug Kubernetes failure
      if: failure() && (steps.cluster-create.outcome == 'failure' || steps.workload-create.outcome == 'failure' || steps.workload-apply.outcome == 'failure' || steps.workload-push-reconcile.outcome == 'failure')
      uses: ./.github/actions/debug-kubernetes-failure
      with:
        kubectl-command: "ksail workload"

    - name: ğŸ§ª ksail cluster stop
      shell: bash
      env:
        HCLOUD_TOKEN: ${{ inputs.hcloud-token }}
      run: |
        ksail cluster stop

    - name: ğŸ§ª ksail cluster start
      shell: bash
      env:
        HCLOUD_TOKEN: ${{ inputs.hcloud-token }}
      run: |
        ksail cluster start

    - name: ğŸ§ª ksail cluster delete
      if: always()
      shell: bash
      env:
        HCLOUD_TOKEN: ${{ inputs.hcloud-token }}
      run: |
        ksail cluster delete
