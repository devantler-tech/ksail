name: CI - Go (Repo)

on:
  push:
    branches: [main]
  pull_request:

concurrency:
  group: "ci-go-repo-${{ github.ref }}"
  cancel-in-progress: true

permissions: {}

jobs:
  # Detect which file categories changed to conditionally run jobs
  changes:
    name: ğŸ” Detect Changes
    runs-on: ubuntu-latest
    permissions:
      contents: read
      pull-requests: read
    outputs:
      code: ${{ steps.filter.outputs.code }}
      schema: ${{ steps.filter.outputs.schema }}
      cli: ${{ steps.filter.outputs.cli }}
    steps:
      - name: ğŸ“„ Checkout
        uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v6.0.1
        with:
          persist-credentials: false

      - name: ğŸ” Filter paths
        uses: dorny/paths-filter@de90cc6fb38fc0963ad72b210f1f284cd68cea36 # v3.0.2
        id: filter
        with:
          filters: |
            code:
              - '**/*.go'
              - 'go.mod'
              - 'go.sum'
              - '.github/actions/**'
            schema:
              - 'pkg/apis/**/*.go'
              - 'go.mod'
              - '.github/scripts/generate-schema*'
            cli:
              - 'cmd/**/*.go'
              - 'pkg/**/*.go'
              - 'go.mod'
              - '.github/scripts/generate-cli-flags-docs.sh'

  build-artifact:
    name: ğŸ—ï¸ Build KSail Binary
    runs-on: ubuntu-latest
    needs: [changes]
    if: needs.changes.outputs.code == 'true' || needs.changes.outputs.cli == 'true' || github.event_name == 'push'
    permissions:
      contents: read
    steps:
      - name: ğŸ“„ Checkout
        uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v6.0.1
        with:
          persist-credentials: false

      - name: âš™ï¸ Setup Go
        id: setup-go
        uses: actions/setup-go@4dc6199c7b1a012772edbd06daecab0f50c9053c # v6.1.0
        with:
          go-version-file: go.mod

      - name: ğŸ“¦ Prepare ksail binary
        uses: ./.github/actions/prepare-ksail-binary
        with:
          go-version: ${{ steps.setup-go.outputs.go-version }}
          source-hash: ${{ hashFiles('go.mod', 'go.sum', '**/*.go') }}
          output-path: /usr/local/bin/ksail

  generate-schema:
    name: ğŸ“ Generate JSON Schema
    runs-on: ubuntu-latest
    needs: [changes]
    if: needs.changes.outputs.schema == 'true' || github.event_name == 'push'
    permissions:
      contents: write
    steps:
      - name: ğŸ”‘ Generate GitHub App Token
        uses: tibdex/github-app-token@3beb63f4bd073e61482598c45c71c1019b59b73a # v2.1.0
        id: generate-token
        with:
          app_id: ${{ vars.APP_ID }}
          private_key: ${{ secrets.APP_PRIVATE_KEY }}

      - name: ğŸ“„ Checkout
        uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v6.0.1
        with:
          persist-credentials: true
          token: ${{ steps.generate-token.outputs.token }}

      - name: âš™ï¸ Setup Go
        uses: actions/setup-go@4dc6199c7b1a012772edbd06daecab0f50c9053c # v6.1.0
        with:
          go-version-file: go.mod

      - name: ğŸ“ Generate JSON schema
        run: .github/scripts/generate-schema.sh

      - name: ğŸ“¤ Commit and push schema changes
        uses: stefanzweifel/git-auto-commit-action@04702edda442b2e678b25b537cec683a1493fcb9 # v7.1.0
        with:
          commit_message: "chore: update generated JSON schema"
          commit_user_name: generator-bot
          commit_user_email: generator-bot@users.noreply.github.com

  generate-cli-flags-docs:
    name: ğŸ“š Generate CLI Flags Docs
    runs-on: ubuntu-latest
    needs: [changes, build-artifact]
    if: needs.changes.outputs.cli == 'true' || github.event_name == 'push'
    permissions:
      contents: write
    steps:
      - name: ğŸ”‘ Generate GitHub App Token
        uses: tibdex/github-app-token@3beb63f4bd073e61482598c45c71c1019b59b73a # v2.1.0
        id: generate-token
        with:
          app_id: ${{ vars.APP_ID }}
          private_key: ${{ secrets.APP_PRIVATE_KEY }}

      - name: ğŸ“„ Checkout
        uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v6.0.1
        with:
          persist-credentials: true
          token: ${{ steps.generate-token.outputs.token }}

      - name: âš™ï¸ Setup Go
        id: setup-go
        uses: actions/setup-go@4dc6199c7b1a012772edbd06daecab0f50c9053c # v6.1.0
        with:
          go-version-file: go.mod

      - name: ğŸ“¦ Prepare ksail binary
        uses: ./.github/actions/prepare-ksail-binary
        with:
          go-version: ${{ steps.setup-go.outputs.go-version }}
          source-hash: ${{ hashFiles('go.mod', 'go.sum', '**/*.go') }}
          output-path: /usr/local/bin/ksail

      - name: ğŸ“š Generate CLI flags documentation
        run: .github/scripts/generate-cli-flags-docs.sh

      - name: ğŸ“¤ Commit and push CLI flags docs
        uses: stefanzweifel/git-auto-commit-action@04702edda442b2e678b25b537cec683a1493fcb9 # v7.1.0
        with:
          commit_message: "chore: update generated CLI flags docs"
          commit_user_name: generator-bot
          commit_user_email: generator-bot@users.noreply.github.com

  ci:
    name: ğŸ”„ CI - Go
    if: github.event_name != 'pull_request'
    uses: devantler-tech/reusable-workflows/.github/workflows/ci-go.yaml@f7c1091196016d2e66b7487ceba166112d196702 # v1.25.0
    secrets:
      CODECOV_TOKEN: ${{ secrets.CODECOV_TOKEN }}
      APP_PRIVATE_KEY: ${{ secrets.APP_PRIVATE_KEY }}
    permissions:
      contents: write
      issues: write
      packages: read
      pull-requests: write

  system-test:
    name: ğŸ§ª System Test
    runs-on: ubuntu-latest
    needs: [changes, build-artifact]
    if: needs.changes.outputs.code == 'true' || github.event_name == 'push'
    strategy:
      matrix:
        include:
          - init-args: "--distribution Kind"
          - init-args: "--distribution Kind --cert-manager Enabled"
          - init-args: "--distribution Kind --cni Cilium"
          - init-args: "--distribution Kind --cni Calico"
          - init-args: "--distribution Kind --csi LocalPathStorage"
          - init-args: "--distribution Kind --gitops-engine Flux"
          - init-args: "--distribution Kind --gitops-engine ArgoCD"
          - init-args: "--distribution Kind --mirror-registry docker.io=https://registry-1.docker.io"
          - init-args: "--distribution Kind --mirror-registry docker.io=https://registry-1.docker.io --mirror-registry ghcr.io=https://ghcr.io"
          - init-args: "--distribution Kind --metrics-server Disabled"
          - init-args: "--distribution K3d"
          - init-args: "--distribution K3d --cert-manager Enabled"
          - init-args: "--distribution K3d --cni Cilium"
          - init-args: "--distribution K3d --cni Calico"
          - init-args: "--distribution K3d --csi LocalPathStorage"
          - init-args: "--distribution K3d --gitops-engine Flux"
          - init-args: "--distribution K3d --gitops-engine ArgoCD"
          - init-args: "--distribution K3d --mirror-registry docker.io=https://registry-1.docker.io"
          - init-args: "--distribution K3d --mirror-registry docker.io=https://registry-1.docker.io --mirror-registry ghcr.io=https://ghcr.io"
          - init-args: "--distribution K3d --metrics-server Disabled"
          - init-args: "--distribution Talos"
          - init-args: "--distribution Talos --cert-manager Enabled"
          - init-args: "--distribution Talos --cni Cilium"
          - init-args: "--distribution Talos --cni Calico"
          - init-args: "--distribution Talos --csi LocalPathStorage"
          - init-args: "--distribution Talos --gitops-engine Flux"
          - init-args: "--distribution Talos --gitops-engine ArgoCD"
          - init-args: "--distribution Talos --mirror-registry docker.io=https://registry-1.docker.io"
          - init-args: "--distribution Talos --mirror-registry docker.io=https://registry-1.docker.io --mirror-registry ghcr.io=https://ghcr.io"
          - init-args: "--distribution Talos --metrics-server Disabled"
    steps:
      - name: ğŸ“„ Checkout
        uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v6.0.1
        with:
          persist-credentials: false

      - name: âš™ï¸ Setup Go
        id: setup-go
        uses: actions/setup-go@4dc6199c7b1a012772edbd06daecab0f50c9053c # v6.1.0
        with:
          go-version-file: go.mod

      - name: ğŸ“¦ Prepare ksail binary
        uses: ./.github/actions/prepare-ksail-binary
        with:
          go-version: ${{ steps.setup-go.outputs.go-version }}
          source-hash: ${{ hashFiles('go.mod', 'go.sum', '**/*.go') }}
          output-path: /usr/local/bin/ksail

      - name: ğŸ§ª ksail cluster init
        run: |
          ksail cluster init ${{ matrix.init-args }}

      - name: ğŸ”§ Load br_netfilter kernel module (required for Talos)
        if: contains(matrix.init-args, 'Talos')
        run: |
          sudo modprobe br_netfilter
          echo "br_netfilter module loaded successfully"

      - name: ğŸ§ª ksail cluster create
        run: |
          ksail cluster create

      - name: ğŸ§ª ksail cluster list
        run: |
          ksail cluster list

      - name: ğŸ§ª ksail workload create
        run: |
          ksail workload create deployment whoami --image=traefik/whoami:latest
          ksail workload wait --for=condition=Available deployment/whoami --timeout=300s

      - name: ğŸ§ª ksail workload apply
        run: |
          ksail workload apply -k .github/fixtures/podinfo-overlay
          ksail workload wait --for=condition=Available deployment/podinfo --timeout=300s

      - name: ğŸ§ª ksail workload push and reconcile
        if: contains(matrix.init-args, '--gitops-engine')
        run: |
          ksail workload push .github/fixtures/reconcile-test
          ksail workload reconcile

      - name: ğŸ§ª ksail cluster stop
        run: |
          ksail cluster stop

      - name: ğŸ§ª ksail cluster start
        run: |
          ksail cluster start

      - name: ğŸ§ª ksail cluster delete
        run: |
          ksail cluster delete

      - name: ğŸ§¹ Cleanup
        run: |
          if [ -d "k8s" ]; then rm -rf "k8s"; fi
          if [ -f "kind.yaml" ]; then rm "kind.yaml"; fi
          if [ -f "k3d.yaml" ]; then rm "k3d.yaml"; fi
          if [ -f "ksail.yaml" ]; then rm "ksail.yaml"; fi

  system-test-status:
    runs-on: ubuntu-latest
    needs: [changes, system-test, build-artifact]
    if: ${{ always() }}
    steps:
      - name: Summarize matrix result
        shell: bash
        run: |
          set -Eeuo pipefail
          echo "system-test result: $MATRIX_RESULT"
          echo "build-artifact result: $BUILD_RESULT"
          echo "code changes: $CODE_CHANGES"
          echo "event name: $EVENT_NAME"

          # If no code changes and not a push, skip is expected
          if [[ "$CODE_CHANGES" != "true" && "$EVENT_NAME" != "push" ]]; then
            echo "âœ… System tests skipped - no code changes detected"
            exit 0
          fi

          # Check matrix result
          case "$MATRIX_RESULT" in
            success|skipped)
              echo "âœ… All matrix runs succeeded or were skipped."
              ;;
            *)
              echo "âŒ At least one matrix run failed."
              exit 1
              ;;
          esac
        env:
          MATRIX_RESULT: ${{ needs.system-test.result }}
          BUILD_RESULT: ${{ needs.build-artifact.result }}
          CODE_CHANGES: ${{ needs.changes.outputs.code }}
          EVENT_NAME: ${{ github.event_name }}
