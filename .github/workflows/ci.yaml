name: CI - KSail

on:
  push:
    branches: [main]
  pull_request:

concurrency:
  group: "ci-ksail-${{ github.ref }}"
  cancel-in-progress: true

permissions: {}

jobs:
  # Detect which file categories changed to conditionally run jobs
  changes:
    name: üîç Detect Changes
    runs-on: ubuntu-latest
    permissions:
      contents: read
      pull-requests: read
    outputs:
      code: ${{ steps.filter.outputs.code }}
      schema: ${{ steps.filter.outputs.schema }}
      cli: ${{ steps.filter.outputs.cli }}
    steps:
      - name: üìÑ Checkout
        uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v6.0.1
        with:
          persist-credentials: false

      - name: üîç Filter paths
        uses: dorny/paths-filter@de90cc6fb38fc0963ad72b210f1f284cd68cea36 # v3.0.2
        id: filter
        with:
          filters: |
            code:
              - '**/*.go'
              - 'go.mod'
              - 'go.sum'
              - '.github/actions/**'
            schema:
              - 'pkg/apis/**/*.go'
              - 'go.mod'
              - '.github/scripts/generate-schema*'
            cli:
              - 'cmd/**/*.go'
              - 'pkg/**/*.go'
              - 'go.mod'
              - '.github/scripts/generate-cli-flags-docs.sh'

  build-artifact:
    name: üèóÔ∏è Build KSail Binary
    runs-on: ubuntu-latest
    needs: [changes]
    if: github.event_name == 'pull_request' && (needs.changes.outputs.code == 'true' || needs.changes.outputs.cli == 'true')
    permissions:
      contents: read
    steps:
      - name: üìÑ Checkout
        uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v6.0.1
        with:
          persist-credentials: false

      - name: ‚öôÔ∏è Setup Go
        id: setup-go
        uses: actions/setup-go@4dc6199c7b1a012772edbd06daecab0f50c9053c # v6.1.0
        with:
          go-version-file: go.mod

      - name: üì¶ Cache KSail Binary
        uses: ./.github/actions/cache-ksail-binary
        with:
          go-version: ${{ steps.setup-go.outputs.go-version }}
          source-hash: ${{ hashFiles('go.mod', 'go.sum', '**/*.go') }}
          output-path: /usr/local/bin/ksail

  generate-schema:
    name: üìù Generate JSON Schema
    runs-on: ubuntu-latest
    needs: [changes]
    if: needs.changes.outputs.schema == 'true'
    permissions:
      contents: write
    steps:
      - name: üîë Generate GitHub App Token
        uses: tibdex/github-app-token@3beb63f4bd073e61482598c45c71c1019b59b73a # v2.1.0
        id: generate-token
        with:
          app_id: ${{ vars.APP_ID }}
          private_key: ${{ secrets.APP_PRIVATE_KEY }}

      - name: üìÑ Checkout
        uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v6.0.1
        with:
          persist-credentials: true
          token: ${{ steps.generate-token.outputs.token }}
          ref: ${{ github.head_ref || github.ref }}

      - name: ‚öôÔ∏è Setup Go
        uses: actions/setup-go@4dc6199c7b1a012772edbd06daecab0f50c9053c # v6.1.0
        with:
          go-version-file: go.mod

      - name: üìù Generate JSON schema
        run: .github/scripts/generate-schema.sh

      - name: üì§ Commit and push schema changes
        uses: stefanzweifel/git-auto-commit-action@04702edda442b2e678b25b537cec683a1493fcb9 # v7.1.0
        with:
          commit_message: "chore: update generated JSON schema"
          commit_user_name: generator-bot
          commit_user_email: generator-bot@users.noreply.github.com

  generate-cli-flags-docs:
    name: üìö Generate CLI Flags Docs
    runs-on: ubuntu-latest
    needs: [changes, build-artifact]
    if: needs.changes.outputs.cli == 'true'
    permissions:
      contents: write
    steps:
      - name: üîë Generate GitHub App Token
        uses: tibdex/github-app-token@3beb63f4bd073e61482598c45c71c1019b59b73a # v2.1.0
        id: generate-token
        with:
          app_id: ${{ vars.APP_ID }}
          private_key: ${{ secrets.APP_PRIVATE_KEY }}

      - name: üìÑ Checkout
        uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v6.0.1
        with:
          persist-credentials: true
          token: ${{ steps.generate-token.outputs.token }}
          ref: ${{ github.head_ref || github.ref }}

      - name: ‚öôÔ∏è Setup Go
        id: setup-go
        uses: actions/setup-go@4dc6199c7b1a012772edbd06daecab0f50c9053c # v6.1.0
        with:
          go-version-file: go.mod

      - name: üì¶ Cache KSail Binary
        uses: ./.github/actions/cache-ksail-binary
        with:
          go-version: ${{ steps.setup-go.outputs.go-version }}
          source-hash: ${{ hashFiles('go.mod', 'go.sum', '**/*.go') }}
          output-path: /usr/local/bin/ksail

      - name: üìö Generate CLI flags documentation
        run: .github/scripts/generate-cli-flags-docs.sh

      - name: üì§ Commit and push CLI flags docs
        uses: stefanzweifel/git-auto-commit-action@04702edda442b2e678b25b537cec683a1493fcb9 # v7.1.0
        with:
          commit_message: "chore: update generated CLI flags docs"
          commit_user_name: generator-bot
          commit_user_email: generator-bot@users.noreply.github.com

  coverage:
    name: üìä Code Coverage
    runs-on: ubuntu-latest
    needs: [changes]
    # Only run on push to main, skip if no code files changed
    if: |
      github.event_name == 'push'
      && github.ref == 'refs/heads/main'
      && needs.changes.outputs.code == 'true'
    permissions:
      contents: write
    steps:
      - name: üìë Checkout
        uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v6.0.1
        with:
          persist-credentials: false

      - name: ‚öôÔ∏è Setup Go
        uses: actions/setup-go@4dc6199c7b1a012772edbd06daecab0f50c9053c # v6.1.0
        with:
          go-version-file: go.mod

      - name: üë®üèª‚Äçüîß Enable covdata (temp) see https://github.com/golang/go/issues/75031
        run: go env -w GOTOOLCHAIN=go1.25.0+auto

      - name: üìÑ Generate coverage
        run: |
          go test -race -coverprofile=coverage.txt -covermode=atomic ./...

      - name: üìÑ Upload coverage to Codecov
        uses: codecov/codecov-action@671740ac38dd9b0130fbe1cec585b89eea48d3de # v5.5.2
        with:
          token: ${{ secrets.CODECOV_TOKEN }}

  system-test:
    name: üß™ System Test
    runs-on: ubuntu-latest
    needs: [changes, build-artifact]
    if: needs.changes.outputs.code == 'true'
    strategy:
      matrix:
        distribution: [Vanilla, K3s, Talos]
        provider: [Docker]
        args:
          - ""
          - "--cert-manager Enabled"
          - "--cni Cilium"
          - "--cni Calico"
          - "--csi LocalPathStorage"
          - "--gitops-engine Flux"
          - "--gitops-engine ArgoCD"
          - "--mirror-registry ghcr.io=https://ghcr.io"
          - "--mirror-registry ghcr.io=https://ghcr.io --mirror-registry docker.io=https://registry-1.docker.io"
          - "--metrics-server Enabled"
          - "--metrics-server Disabled"
          - "--policy-engine Kyverno"
          - "--policy-engine Gatekeeper"
        init: [true, false]
    steps:
      - name: üßπ Free disk space
        run: |
          # Talos containers run inside Docker and need significant disk space.
          # GitHub runners have limited disk (~14GB free), which causes DiskPressure
          # when Talos pulls CNI images (Cilium/Calico) and runs workloads.
          # Free up space by removing unused tools and images.
          echo "Disk space before cleanup:"
          df -h /

          # Remove large pre-installed tools we don't need
          sudo rm -rf /usr/share/dotnet
          sudo rm -rf /usr/local/lib/android
          sudo rm -rf /opt/ghc
          sudo rm -rf /opt/hostedtoolcache/CodeQL

          # Clean Docker
          docker system prune -af --volumes || true

          echo "Disk space after cleanup:"
          df -h /

      - name: üìÑ Checkout
        uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v6.0.1
        with:
          persist-credentials: false

      - name: ‚öôÔ∏è Setup Go
        id: setup-go
        uses: actions/setup-go@4dc6199c7b1a012772edbd06daecab0f50c9053c # v6.1.0
        with:
          go-version-file: go.mod

      - name: üì¶ Cache KSail Binary
        uses: ./.github/actions/cache-ksail-binary
        with:
          go-version: ${{ steps.setup-go.outputs.go-version }}
          source-hash: ${{ hashFiles('go.mod', 'go.sum', '**/*.go') }}
          output-path: /usr/local/bin/ksail

      - name: üß™ ksail cluster init
        if: matrix.init == true
        run: |
          ksail cluster init --distribution ${{ matrix.distribution }} --provider ${{ matrix.provider }} ${{ matrix.args }}

      - name: üß™ ksail cluster create
        run: |
          if [ "${{ matrix.init }}" = true ]; then
            ksail cluster create
          else
            ksail cluster create --distribution ${{ matrix.distribution }} --provider ${{ matrix.provider }} ${{ matrix.args }}
          fi

      - name: üß™ ksail cluster list
        run: |
          ksail cluster list

      - name: üß™ ksail workload create
        id: workload-create
        run: |
          ksail workload create deployment whoami --image=traefik/whoami:latest
          ksail workload wait --for=condition=Available deployment/whoami --timeout=300s

      - name: üß™ ksail workload apply
        id: workload-apply
        run: |
          ksail workload apply -k .github/fixtures/podinfo-overlay
          ksail workload wait --for=condition=Available deployment/podinfo --timeout=300s

      - name: üß™ ksail workload push and reconcile
        id: workload-push-reconcile
        if: contains(matrix.args, '--gitops-engine')
        run: |
          mkdir -p k8s
          if [ ! -f "k8s/kustomization.yaml" ]; then
            echo "apiVersion: kustomize.config.k8s.io/v1beta1" > k8s/kustomization.yaml
            echo "kind: Kustomization" >> k8s/kustomization.yaml
            echo "resources: []" >> k8s/kustomization.yaml
          fi
          ksail workload push --path k8s/
          ksail workload reconcile

      - name: üêû Debug workload failure
        if: failure() && (steps.workload-create.outcome == 'failure' || steps.workload-apply.outcome == 'failure' || steps.workload-push-reconcile.outcome == 'failure')
        run: |
          echo "=== Disk Usage ==="
          df -h /
          echo ""
          echo "=== Docker Disk Usage ==="
          docker system df || true
          echo ""
          echo "=== Node Status ==="
          ksail workload get nodes -o wide || true
          echo ""
          echo "=== Node Describe (conditions) ==="
          ksail workload describe nodes | grep -A 20 "Conditions:" || true
          echo ""
          echo "=== Pod Status ==="
          ksail workload get pods -o wide || true
          echo ""
          echo "=== Pod Events ==="
          ksail workload get events --sort-by='.lastTimestamp' | tail -50 || true

      - name: üß™ ksail cluster stop
        run: |
          ksail cluster stop

      - name: üß™ ksail cluster start
        run: |
          ksail cluster start

      - name: üß™ ksail cluster delete
        run: |
          ksail cluster delete

      - name: üßπ Cleanup
        run: |
          if [ -f "ksail.yaml" ]; then rm "ksail.yaml"; fi
          if [ -f "kind.yaml" ]; then rm "kind.yaml"; fi
          if [ -d "kind" ]; then rm -rf "kind"; fi
          if [ -f "k3d.yaml" ]; then rm "k3d.yaml"; fi
          if [ -d "talos" ]; then rm -rf "talos"; fi
          if [ -d "k8s" ]; then rm -rf "k8s"; fi

  status:
    name: CI - KSail
    runs-on: ubuntu-latest
    needs: [changes, build-artifact, generate-schema, generate-cli-flags-docs, coverage, system-test]
    if: ${{ always() }}
    steps:
      - name: Summarize workflow result
        shell: bash
        run: |
          set -Eeuo pipefail
          failed=false
          for result in "$CHANGES_RESULT" "$BUILD_RESULT" "$SCHEMA_RESULT" "$CLI_DOCS_RESULT" "$COVERAGE_RESULT" "$SYSTEM_TEST_RESULT"; do
            case "$result" in
              success|skipped)
                ;;
              *)
                failed=true
                ;;
            esac
          done

          if [ "$failed" = true ]; then
            echo "‚ùå At least one job failed."
            exit 1
          fi

          echo "‚úÖ All jobs succeeded or were skipped."
        env:
          CHANGES_RESULT: ${{ needs.changes.result }}
          BUILD_RESULT: ${{ needs.build-artifact.result }}
          SCHEMA_RESULT: ${{ needs.generate-schema.result }}
          CLI_DOCS_RESULT: ${{ needs.generate-cli-flags-docs.result }}
          COVERAGE_RESULT: ${{ needs.coverage.result }}
          SYSTEM_TEST_RESULT: ${{ needs.system-test.result }}
          CODE_CHANGES: ${{ needs.changes.outputs.code }}
          EVENT_NAME: ${{ github.event_name }}
