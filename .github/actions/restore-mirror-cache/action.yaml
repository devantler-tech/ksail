name: Restore Mirror Cache
description: |
  Restores the pre-warmed mirror cache volumes created by warm-mirror-cache.
  Use this in system test jobs to benefit from the warmed cache.

inputs:
  cache-version:
    description: |
      Version salt for cache key. Must match warm-mirror-cache.
    required: false
    default: "v1"

outputs:
  cache-hit:
    description: Whether the cache was found and restored
    value: ${{ steps.restore-cache.outputs.cache-hit || 'false' }}

runs:
  using: composite
  steps:
    - name: üîë Generate cache key
      id: generate-key
      shell: bash
      env:
        CACHE_VERSION: ${{ inputs.cache-version }}
        RUNNER_OS: ${{ runner.os }}
        RUNNER_ARCH: ${{ runner.arch }}
      run: |
        GO_MOD_HASH="${{ hashFiles('go.mod', 'go.sum') }}"
        HASH_SHORT="${GO_MOD_HASH:0:12}"
        CACHE_KEY="mirror-cache-${CACHE_VERSION}-${HASH_SHORT}-${RUNNER_OS}-${RUNNER_ARCH}"
        echo "cache-key=$CACHE_KEY" >> "$GITHUB_OUTPUT"

    - name: üì• Restore mirror cache
      id: restore-cache
      uses: actions/cache/restore@5a3ec84eff668545956fd18022155c47e93e2684 # v4.2.3
      with:
        path: /tmp/mirror-cache
        key: ${{ steps.generate-key.outputs.cache-key }}
        restore-keys: |
          mirror-cache-${{ inputs.cache-version }}-

    - name: üì¶ Import mirror volumes
      if: steps.restore-cache.outputs.cache-hit == 'true'
      shell: bash
      run: |
        echo "üì¶ Importing mirror registry volumes..."

        # Import docker.io mirror volume
        if [ -f "/tmp/mirror-cache/docker.io.tar" ]; then
          docker volume create docker.io 2>/dev/null || true
          docker run --rm \
            -v docker.io:/volume \
            -v /tmp/mirror-cache:/backup:ro \
            busybox \
            sh -c "cd /volume && tar -xf /backup/docker.io.tar" || echo "‚ö†Ô∏è Failed to import docker.io mirror"
          echo "‚úÖ Restored docker.io mirror cache"
        fi

        # Import ghcr.io mirror volume
        if [ -f "/tmp/mirror-cache/ghcr.io.tar" ]; then
          docker volume create ghcr.io 2>/dev/null || true
          docker run --rm \
            -v ghcr.io:/volume \
            -v /tmp/mirror-cache:/backup:ro \
            busybox \
            sh -c "cd /volume && tar -xf /backup/ghcr.io.tar" || echo "‚ö†Ô∏è Failed to import ghcr.io mirror"
          echo "‚úÖ Restored ghcr.io mirror cache"
        fi

        # Import quay.io mirror volume
        if [ -f "/tmp/mirror-cache/quay.io.tar" ]; then
          docker volume create quay.io 2>/dev/null || true
          docker run --rm \
            -v quay.io:/volume \
            -v /tmp/mirror-cache:/backup:ro \
            busybox \
            sh -c "cd /volume && tar -xf /backup/quay.io.tar" || echo "‚ö†Ô∏è Failed to import quay.io mirror"
          echo "‚úÖ Restored quay.io mirror cache"
        fi

        # Import registry.k8s.io mirror volume
        if [ -f "/tmp/mirror-cache/registry.k8s.io.tar" ]; then
          docker volume create registry.k8s.io 2>/dev/null || true
          docker run --rm \
            -v registry.k8s.io:/volume \
            -v /tmp/mirror-cache:/backup:ro \
            busybox \
            sh -c "cd /volume && tar -xf /backup/registry.k8s.io.tar" || echo "‚ö†Ô∏è Failed to import registry.k8s.io mirror"
          echo "‚úÖ Restored registry.k8s.io mirror cache"
        fi

    - name: ‚ÑπÔ∏è Cache miss notice
      if: steps.restore-cache.outputs.cache-hit != 'true'
      shell: bash
      run: |
        echo "‚ö†Ô∏è Mirror cache not found. Images will be pulled directly."
        echo "   This may increase test duration and risk rate limits."
        echo "   The warm-mirror-cache job should run before system tests."
