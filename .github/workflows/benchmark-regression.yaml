name: Benchmark Regression

on:
  pull_request:
    paths:
      - "**/*.go"
      - "go.mod"
      - "go.sum"

env:
  GOPROXY: "https://proxy.golang.org|direct"

concurrency:
  group: "benchmark-${{ github.workflow }}-${{ github.ref }}"
  cancel-in-progress: true

permissions: {}

jobs:
  benchmark:
    name: ðŸ“Š Benchmark Regression
    runs-on: ubuntu-latest
    permissions:
      contents: read
      pull-requests: write
    steps:
      - name: ðŸ“„ Checkout PR branch
        uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6.0.2
        with:
          persist-credentials: false

      - name: âš™ï¸ Setup Go
        uses: actions/setup-go@7a3fe6cf4cb3a834922a1244abfce67bcef6a0c5 # v6.2.0
        with:
          go-version-file: go.mod

      - name: ðŸ“¦ Install benchstat
        run: go install golang.org/x/perf/cmd/benchstat@latest

      - name: ðŸƒ Run benchmarks on PR branch
        run: |
          go test -bench=. -benchmem -count=5 -benchtime=3s -run=^$ -timeout=30m ./... 2>/dev/null | tee pr-bench.txt

      - name: ðŸ“„ Checkout main branch
        uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6.0.2
        with:
          ref: main
          persist-credentials: false

      - name: ðŸƒ Run benchmarks on main branch
        run: |
          go test -bench=. -benchmem -count=5 -benchtime=3s -run=^$ -timeout=30m ./... 2>/dev/null | tee main-bench.txt

      - name: ðŸ“Š Compare benchmarks
        id: benchstat
        run: |
          result=$(benchstat main-bench.txt pr-bench.txt 2>&1) || true
          {
            echo "result<<BENCHSTAT_EOF"
            echo "$result"
            echo "BENCHSTAT_EOF"
          } >> "$GITHUB_OUTPUT"

      - name: ðŸ’¬ Post benchmark comparison
        uses: actions/github-script@60a0d83039c74a4aee543508d2ffcb1c3799cdea # v7.0.1
        with:
          script: |
            const body = `## ðŸ“Š Benchmark Regression Report

            <details>
            <summary>Benchmark comparison (main vs PR)</summary>

            \`\`\`
            ${process.env.BENCHSTAT_RESULT}
            \`\`\`

            </details>

            ### How to interpret

            - **sec/op**: Time per operation (lower is better)
            - **B/op**: Bytes allocated per operation (lower is better)
            - **allocs/op**: Allocations per operation (lower is better)
            - **~**: No statistically significant change (p â‰¥ 0.05)
            - **p-value**: Statistical confidence; values below 0.05 indicate a significant change

            > Generated by the [Benchmark Regression](${context.serverUrl}/${context.repo.owner}/${context.repo.repo}/actions/runs/${context.runId}) workflow. See [docs/BENCHMARK-REGRESSION.md](docs/BENCHMARK-REGRESSION.md) for details.
            `;

            const { data: comments } = await github.rest.issues.listComments({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
            });

            const marker = '## ðŸ“Š Benchmark Regression Report';
            const existing = comments.find(c => c.body.includes(marker));

            if (existing) {
              await github.rest.issues.updateComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                comment_id: existing.id,
                body,
              });
            } else {
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.issue.number,
                body,
              });
            }
        env:
          BENCHSTAT_RESULT: ${{ steps.benchstat.outputs.result }}
