---
name: CD
on:
  push:
    tags:
      - "v*"

env:
  # Use pipe (|) instead of comma (,) so Go falls through to direct on ANY proxy
  # error (including 403), not just 404/410. Hardens CI against transient
  # proxy.golang.org outages. go.sum still verifies module integrity.
  GOPROXY: "https://proxy.golang.org|direct"

concurrency:
  group: "${{ github.workflow }}-${{ github.ref }}"
  cancel-in-progress: false

jobs:
  goreleaser:
    name: Release with GoReleaser
    runs-on: ubuntu-latest
    permissions:
      contents: write
      packages: write
    steps:
      - name: ğŸ“‘ Checkout
        uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6.0.2
        with:
          fetch-depth: 0
          persist-credentials: false

      - name: ğŸ§¹ Cleanup node
        run: |
          sudo rm -rf /usr/share/dotnet /usr/local/lib/android /opt/ghc /opt/hostedtoolcache/CodeQL
          sudo docker image prune --all --force
          sudo docker builder prune -a

      - name: âš™ï¸ Setup Go
        uses: actions/setup-go@7a3fe6cf4cb3a834922a1244abfce67bcef6a0c5 # v6.2.0
        with:
          go-version-file: go.mod
          # Disable module cache restoration in release workflows to avoid
          # cache-poisoning risk for runtime artifacts (see https://docs.zizmor.sh/audits/#cache-poisoning)
          cache: false

      - name: âš™ï¸ Setup Docker Buildx
        uses: docker/setup-buildx-action@8d2750c68a42422c14e847fe6c8ac0403b4cbd6f # v3.12.0

      - name: ğŸ” Login to GHCR
        uses: docker/login-action@c94ce9fb468520275223c153574b00df6fe4bcc9 # v3.7.0
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: ğŸ—ï¸ Run GoReleaser
        uses: goreleaser/goreleaser-action@e435ccd777264be153ace6237001ef4d979d3a7a # v6.4.0
        with:
          distribution: goreleaser
          version: "~> v2"
          args: release --clean
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          HOMEBREW_GITHUB_API_TOKEN: ${{ secrets.HOMEBREW_GITHUB_API_TOKEN }}
          GPG_PRIVATE_KEY: ${{ secrets.GPG_PRIVATE_KEY }}

  vscode-extension:
    name: ğŸ§© Release VSCode Extension
    runs-on: ubuntu-latest
    needs: [goreleaser]
    permissions:
      contents: write
    defaults:
      run:
        working-directory: vsce
    steps:
      - name: ğŸ“„ Checkout
        uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6.0.2
        with:
          persist-credentials: false

      - name: âš™ï¸ Setup Node.js
        uses: actions/setup-node@6044e13b5dc448c55e2357c09f80417699197238 # v6.2.0 # zizmor: ignore[cache-poisoning]
        with:
          node-version: "22"

      - name: ğŸ·ï¸ Extract version from tag
        id: get_version
        run: echo "version=${GITHUB_REF#refs/tags/v}" >> "$GITHUB_OUTPUT"

      - name: ğŸ“¦ Install dependencies
        run: npm ci

      - name: ğŸ—ï¸ Compile
        run: npm run compile

      - name: ğŸ“¦ Package extension
        run: npm run package

      - name: ğŸ“¤ Publish to VS Code Marketplace
        run: npx @vscode/vsce publish "$VERSION"
        env:
          VSCE_PAT: ${{ secrets.VSCE_PAT }}
          VERSION: ${{ steps.get_version.outputs.version }}
        continue-on-error: true

      # - name: ğŸ“¤ Publish to Open VSX Registry
      #   run: npx ovsx publish --pat ${{ secrets.OVSX_PAT }}
      #   env:
      #     OVSX_PAT: ${{ secrets.OVSX_PAT }}
      #   continue-on-error: true

      - name: ğŸ“¦ Create VSIX package
        run: npx @vscode/vsce package "$VERSION" --out ksail_"$VERSION".vsix
        env:
          VERSION: ${{ steps.get_version.outputs.version }}

      - name: ğŸ“¤ Upload VSIX to release
        uses: softprops/action-gh-release@a06a81a03ee405af7f2048a818ed3f03bbf83c7b # v2.5.0
        with:
          files: vsce/ksail_*.vsix
          draft: true

  publish-fig-spec:
    name: ğŸ”® Publish CLI Completion Spec
    runs-on: ubuntu-latest
    needs: [goreleaser]
    permissions:
      contents: write
    steps:
      - name: ğŸ“„ Checkout KSail
        uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6.0.2
        with:
          persist-credentials: false
          path: ksail

      - name: ğŸ“¤ Upload completion spec to release
        uses: softprops/action-gh-release@a06a81a03ee405af7f2048a818ed3f03bbf83c7b # v2.5.0
        with:
          files: ksail/completions/ksail.ts
          draft: true

      - name: ğŸ´ Ensure fork of withfig/autocomplete exists
        uses: actions/github-script@ed597411d8f924073f98dfc5c65a23a2325f34cd # v8.0.0
        with:
          github-token: ${{ secrets.AUTOCOMPLETE_PAT }}
          script: |
            try {
              await github.rest.repos.get({
                owner: 'devantler-tech',
                repo: 'autocomplete',
              });
              console.log('Fork devantler-tech/autocomplete already exists');
            } catch (error) {
              if (error.status === 404) {
                console.log('Forking withfig/autocomplete to devantler-tech...');
                await github.rest.repos.createFork({
                  owner: 'withfig',
                  repo: 'autocomplete',
                  organization: 'devantler-tech',
                });
                // Wait for fork to be ready
                let ready = false;
                for (let i = 0; i < 10; i++) {
                  await new Promise(r => setTimeout(r, 5000));
                  try {
                    await github.rest.repos.get({
                      owner: 'devantler-tech',
                      repo: 'autocomplete',
                    });
                    ready = true;
                    break;
                  } catch { /* fork not ready yet */ }
                }
                if (!ready) {
                  core.setFailed('Fork creation timed out');
                }
                console.log('Fork created successfully');
              } else {
                throw error;
              }
            }

      - name: ğŸ“„ Checkout withfig/autocomplete
        uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6.0.2
        with:
          repository: withfig/autocomplete
          path: autocomplete
          token: ${{ secrets.AUTOCOMPLETE_PAT }}

      - name: ğŸ”® Copy completion spec
        run: cp ksail/completions/ksail.ts autocomplete/src/ksail.ts

      - name: ğŸ“¤ Create PR to withfig/autocomplete
        uses: peter-evans/create-pull-request@c0f553fe549906ede9cf27b5156039d195d2ece0 # v8.1.0
        with:
          token: ${{ secrets.AUTOCOMPLETE_PAT }}
          path: autocomplete
          push-to-fork: devantler-tech/autocomplete
          branch: feat/update-ksail-completion-spec
          delete-branch: true
          title: "feat(ksail): update completion spec to ${{ github.ref_name }}"
          body: |
            Updates the [KSail](https://github.com/devantler-tech/ksail) CLI completion spec to match version `${{ github.ref_name }}`.

            Auto-generated by the [KSail CD workflow](https://github.com/devantler-tech/ksail/actions/workflows/cd.yaml).
          commit-message: "feat(ksail): update completion spec to ${{ github.ref_name }}"
          committer: "generator-bot <generator-bot@users.noreply.github.com>"

  publish-release:
    name: ğŸ“¢ Publish Release
    runs-on: ubuntu-latest
    needs: [goreleaser, vscode-extension, publish-fig-spec]
    permissions:
      contents: write
    steps:
      - name: ğŸ·ï¸ Extract version from tag
        id: get_version
        run: echo "version=${GITHUB_REF#refs/tags/}" >> "$GITHUB_OUTPUT"

      - name: ğŸ“¢ Publish draft release
        uses: actions/github-script@ed597411d8f924073f98dfc5c65a23a2325f34cd # v8.0.0
        env:
          RELEASE_TAG: ${{ steps.get_version.outputs.version }}
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const tag = process.env.RELEASE_TAG;

            // List releases and find the one matching the tag
            // Note: getReleaseByTag does not return draft releases, so we use listReleases instead
            let release;
            try {
              const { data: releases } = await github.rest.repos.listReleases({
                owner: context.repo.owner,
                repo: context.repo.repo,
                per_page: 100,
              });
              release = releases.find(r => r.tag_name === tag);
            } catch (error) {
              core.setFailed(`Failed to list releases: ${error.message}`);
              throw error;
            }

            if (!release) {
              core.setFailed(`Release not found for tag ${tag}`);
              return;
            }

            if (!release.draft) {
              console.log(`Release ${tag} is already published`);
              return;
            }

            // Publish the release
            await github.rest.repos.updateRelease({
              owner: context.repo.owner,
              repo: context.repo.repo,
              release_id: release.id,
              draft: false,
            });

            console.log(`Successfully published release ${tag}`);
