name: Daily Test Improver - Coverage Steps
description: Builds the project, runs tests, and generates coverage reports

runs:
  using: composite
  steps:
    # Step 1: Setup Go environment with module caching
    - name: âš™ï¸ Setup Go
      uses: actions/setup-go@7a3fe6cf4cb3a834922a1244abfce67bcef6a0c5 # v6.2.0
      with:
        go-version-file: go.mod
        cache: true
        cache-dependency-path: go.sum
    
    # Step 2: Verify Go installation
    - name: âœ… Verify Go setup
      shell: bash
      run: |
        echo "Verifying Go environment..." | tee -a coverage-steps.log
        go version | tee -a coverage-steps.log
        echo "âœ… Go setup complete" | tee -a coverage-steps.log

    # Step 3: Download dependencies
    - name: ðŸ“¦ Download Go modules
      shell: bash
      env:
        GOPROXY: https://proxy.golang.org,direct
      run: |
        echo "Downloading Go modules..." | tee -a coverage-steps.log
        go mod download 2>&1 | tee -a coverage-steps.log
        echo "âœ… Go modules downloaded" | tee -a coverage-steps.log

    # Step 4: Build the KSail binary
    - name: ðŸ—ï¸ Build KSail binary
      shell: bash
      env:
        GOPROXY: https://proxy.golang.org,direct
      run: |
        echo "Building KSail binary..." | tee -a coverage-steps.log
        go build -o ksail . 2>&1 | tee -a coverage-steps.log
        echo "âœ… Build successful" | tee -a coverage-steps.log

    # Step 5: Enable covdata workaround
    - name: ðŸ‘¨ðŸ»â€ðŸ”§ Enable covdata
      shell: bash
      run: |
        echo "Enabling covdata workaround..." | tee -a coverage-steps.log
        go env -w GOTOOLCHAIN=go1.25.4+auto 2>&1 | tee -a coverage-steps.log
        echo "âœ… Covdata enabled" | tee -a coverage-steps.log

    # Step 6: Run unit tests with coverage
    - name: ðŸ“Š Run tests and generate coverage
      shell: bash
      env:
        GOPROXY: https://proxy.golang.org,direct
      run: |
        echo "Running tests with coverage..." | tee -a coverage-steps.log
        go test -race -coverprofile=coverage.txt -covermode=atomic ./... 2>&1 | tee -a coverage-steps.log
        echo "âœ… Tests complete, coverage generated at: coverage.txt" | tee -a coverage-steps.log

    # Step 7: Display coverage summary
    - name: ðŸ“ˆ Display coverage summary
      shell: bash
      run: |
        echo "Coverage summary by package:" | tee -a coverage-steps.log
        go tool cover -func=coverage.txt 2>&1 | tee -a coverage-steps.log
        echo "âœ… Coverage summary complete" | tee -a coverage-steps.log

    # Step 8: Generate HTML coverage report
    - name: ðŸ“„ Generate HTML coverage report
      shell: bash
      run: |
        echo "Generating HTML coverage report..." | tee -a coverage-steps.log
        go tool cover -html=coverage.txt -o coverage.html 2>&1 | tee -a coverage-steps.log
        echo "âœ… HTML coverage report generated at: coverage.html" | tee -a coverage-steps.log

    # Step 9: Upload coverage artifacts
    - name: ðŸ“¤ Upload coverage reports
      uses: actions/upload-artifact@ea054b56044de43c62e384c6396ee2371e6d0e4b # v4.6.2
      with:
        name: coverage
        path: |
          coverage.txt
          coverage.html
          coverage-steps.log
        retention-days: 90
